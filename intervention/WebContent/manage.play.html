<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>Manage Game</title>
<meta name="description" content="Manage Game">
<meta name="viewport" content="width=device-width">
<!-- Material Design fonts -->
<link rel="stylesheet"
	href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700"
	type="text/css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">



<!-- Bootstrap Material Design -->
<link
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	rel="stylesheet">
<link href="css/bootstrap-material-design.css" rel="stylesheet">
<link href="css/ripples.min.css" rel="stylesheet">
<link href="css/main.css" rel="stylesheet">

<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/ripples.min.js"></script>
<script type="text/javascript" src="js/material.min.js"></script>

<script type="text/javascript" src="js/urls.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript"
	src="http://www.parsecdn.com/js/parse-latest.js"></script>

<script>
	$.material.init();
</script>
</head>
<body>
	<nav class="navbar_global navbar navbar-default navbar-static-top">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">

				<a class="navbar-brand" href="javascript:Utils.goPage(Urls.HOME);">Intervention
					<i>Online</i>
				</a>
				 <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				  </button>
			</div>
			<ul class="nav navbar-nav navbar-right">
			
				<li class="dropdown"><a href="#" class="dropdown-toggle"
					data-toggle="dropdown" role="button" aria-haspopup="true"
					aria-expanded="false">Manager Options<span class="caret"></span></a>
					<ul class="dropdown-menu">
						<li><a href="javascript:EndGame()">End Game</a></li>
						<li><a href="javascript:CloseAndDelete()">Close and
								Delete Game</a></li>
					</ul></li>
			</ul>
			<div class="navbar-collapse collapse navbar-responsive-collapse">
			<!-- Collect the nav links, forms, and other content for toggling -->
			
			<ul class="nav navbar-nav navbar-right">
				<li class="dropdown"><a href="#" class="dropdown-toggle"
					data-toggle="dropdown" role="button" aria-haspopup="true"
					aria-expanded="false">Signed in as <span class="username">[UserName]</span>
						<span class="caret"></span></a>
					<ul class="dropdown-menu">
						<li><a href="#">Settings</a></li>
						<li><a href="javascript:Utils.logout()">Logout</a></li>
					</ul></li>
			</ul>
			</div>
		</div>
		<!-- /.container-fluid -->
	</nav>
	<div class="main container">
		<div class="row">

			<div class="col-md-12">
				<div class="bs-component">
					<div class="jumbotron">

						<h2><span class="locked_in_players">0</span> of <span class="num_of_players">0</span> players locked in</h2>

						<div class="player_wrapper row show-grid">
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row">

			<div class="col-md-12">
				<div class="bs-component">
					<div class="jumbotron">
					<div class="row">
						<div class="col-md-8">
							<h1>Welcome Manager</h1>
							<br>
							<p>Link to Main display screen</p>
							<span class="fine">This screen is used to display the
								current question, scores, and players</span> <input type="text"
								class="link_to_main" style="width: 100%" onclick="this.select()" />
							<h3>Current Score</h3>
							<h3><span class="player_score">0</span></h3><br>
							
						</div>
						<div class="col-md-4" style="float:right;padding-top:16px">
							<a href="#" class="btn btn-raised btn-default" >Scoreboard</a>
									<a href="#" class=" btn btn-raised btn-default" >View Question History</a>
							  <button  disabled class="calculateresultsbutton btn btn-raised btn-primary" type="button"  data-toggle="dropdown">Calculate Results </button>
							 <button  disabled class="calculateresultsbutton btn btn-raised btn-primary" type="button"  disabled data-toggle="dropdown">Next Question </button>
						</div>
						</div>
					</div>
				</div>
			</div>

		</div>
		<div class="row">
			<div class="col-md-12">
				<div class="error alert alert-dismissible alert-danger"
					style="display: none" role="alert"></div>
			</div>
		</div>

		




	</div>

</body>
<script>
	var gameId;
	var ownerId;
	//parse objects
	var game;
	var owner;


	var listOfPlayers = [];
	var listOfLockedInPlayers = [];

	$(document).ready(function() {
		if (!Utils.userLoggedIn()) {
			Utils.goPage(Urls.LOGIN);
		}

		//setting username
		var user = Parse.User.current();
		$(".username").html(user.get("displayName"));

		gameId = Utils.getParameterByName("gameId");
		
		

		grabObjects();
	});

	//gameId and ownerId must be set.
	function grabObjects() {

		var currentgame = Parse.Object.extend("game");
		var query = new Parse.Query(currentgame);
		query.equalTo("unique_id", gameId);
		query.equalTo("active", true);
		query
				.first({
					success : function(object) {
						game = object;
						if (game.get("owner_id") !== Utils.getCurrentUser().id) {
							Utils
									.showError("You do not own this game, therefore you cannot manage");
							setTimeout(Utils.goPage(Urls.HOME), 3000);
							return;
						} else if (!game.get("started")) {

							$(".main").html("<strong>Wow...</strong> Don't get ahead of yourself, this game hasn't started yet")
						} else {
							owner = Utils.getCurrentUser(false);
							initGame();
						}

						
					},
					error : function(error) {
						Utils.showError(error.message);
					}
				});
	}

	function updateLabels(){
			for ( var i = 0; i < listOfLockedInPlayers.length; i++) {
					var id = listOfLockedInPlayers[i].id
					var className = "lockedlabel" + id;

					var panel = '<div class="panel panel-success">  <div class="panel-heading">    <h3 class="panel-title"><span class="glyphicon glyphicon-lock" aria-hidden="true"></span> NAME</h3>  </div>  <div class="panel-body"><a href="STATS">View Stats</a></div></div>'

					var name =  listOfLockedInPlayers[i].get("displayName");

					if(listOfLockedInPlayers[i].id==Utils.getCurrentUser(false).id){
						name = "<strong>Yourself</strong>"
					}
					panel = panel.replace("NAME", name);
					panel = panel.replace("STATS", Urls.STATS + "?userId=" + id);

					$("."+className).html(panel);
			}
	}

	function pollForLockedInPlayers(){
		//get all locked players in the game and update the ones who are "locked in" to a different class.
		//if all are locked in, no need to poll further
			var gameLocks = Parse.Object.extend("gameLocks");
					var query = new Parse.Query(gameLocks);
					query.equalTo("game", game);
					query.include("user");
					query
						.find({
							success : function(results) {
									listOfLockedInPlayers = [];
								for ( var i = 0; i < results.length; i++) {
									if(results[i].get("locked")){
										listOfLockedInPlayers.push(results[i].get("user"));
									}
								}

								$(".num_of_players").html(listOfPlayers.length);
								$(".locked_in_players").html(listOfLockedInPlayers.length);

								updateLabels();

								if(listOfLockedInPlayers.length !== listOfPlayers.length){
									setTimeout(pollForLockedInPlayers,1000);
								}
							},
							error : function(error) {
								Utils.showError(error.message);
							}
						});


		
	}

	function showPlayers(){
		for(var i =0; i<listOfPlayers.length;i++){
			var player = listOfPlayers[i];
			var className = "lockedlabel" + player.id;
			var panel = '<div style="display:none" class="'+className+' unlockedplayer col-xs-4"><div class="panel panel-default"> <span style="display:none" class="glyphicon glyphicon-lock" aria-hidden="true"></span> <div class="panel-heading">    <h3 class="panel-title">NAME</h3>  </div>  <div class="panel-body"><a href="STATS">View Stats</a></div></div></div>'

			var name =  listOfPlayers[i].get("displayName");

					if(listOfPlayers[i].id==Utils.getCurrentUser(false).id){
						name = "<strong>Yourself</strong>"
					}
					panel = panel.replace("NAME", name);

			panel = panel.replace("NAME", name);
			panel = panel.replace("STATS", Urls.STATS + "?userId=" + player.id);

			$(".player_wrapper").append(panel);
			$("." + className).fadeIn()
		
	}
		

		pollForLockedInPlayers();
	}

	function getPlayers(){
		var Users = Parse.Object.extend("User");
			var query = new Parse.Query(Users);
			query.equalTo("game_id", String(gameId));
			query
			.find({
				success : function(results) {
						//resetting
						listOfPlayers = [];
						for ( var i = 0; i < results.length; i++) {
							listOfPlayers.push(results[i]);
						}

						showPlayers();

					},
					error : function(error) {
						Utils.showError(error.message);
					}
				});
	}

	function initGame() {
		
		getPlayers();
		makeGameLock(false);
		
		$(".link_to_main").val(
				window.location.href.split("/manage")[0] + "/" + Urls.MAIN
						+ "?gameId=" + game.get("unique_id"));

	}


	function CloseAndDelete() {
		//delete game from table
		//unset any user game_id that has this game set
		game.destroy({
			success: function(myObject) {
				console.log("game deleted successfully");
				$(".main").html("Game has been deleted, click <a href='"+Urls.HOME+"'>here</a> to go home");
			},
			error: function(myObject, error) {
				Utils.showError(error.message);
			}
		});
		
		
	}

	function EndGame() {
		
	}
	function makeGameLock(bLocked){
	console.log("making game lock")
	var GameLock = Parse.Object.extend("gameLocks");
	var query = new Parse.Query(GameLock);
	query.equalTo("user",Utils.getCurrentUser(true));

	query.first({
		success: function(foundlock) {
					if(foundlock==undefined || foundlock.length==0){
				//need to make it 
				//(only if they've never been in a game)
				var GameLock = Parse.Object.extend("gameLocks");
				var lock = new GameLock();
				lock.set("game",game);
				lock.set("user",Utils.getCurrentUser(false));
				
				
				lock.set("locked",bLocked);
				lock.save(null, {
					success: function(newGame) {
					// Execute any logic that should take place after the object is saved.
					console.log("lock created");
				},
				error: function(newGame, error) {
					// Execute any logic that should take place if the save fails.
					// error is a Parse.Error with an error code and message.
					console.log(error.message)
				}
			});
	} else {
		//need to update it
		//game
		//blocked
		
		
		foundlock.set("game",game);
		foundlock.set("user",Utils.getCurrentUser(false));
		foundlock.set("locked",bLocked);
		foundlock.save(null, {
			success: function(newGame) {
				// Execute any logic that should take place after the object is saved.
				console.log("lock updated");
			},
			error: function(newGame, error) {
				// Execute any logic that should take place if the save fails.
				// error is a Parse.Error with an error code and message.
				console.log(error.message)
			}
		});
	}

},
error: function(lock, error) {
	Utils.showError(error.message);
}
});
}


</script>
</html>
