<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>Home</title>
<meta name="description" content="Home">
<meta name="viewport" content="width=device-width">
<!-- Material Design fonts -->
<link rel="stylesheet"
	href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700"
	type="text/css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">



<!-- Bootstrap Material Design -->
<link
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	rel="stylesheet">
<link href="css/bootstrap-material-design.css" rel="stylesheet">
<link href="css/ripples.min.css" rel="stylesheet">
<link href="css/main.css" rel="stylesheet">

<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/ripples.min.js"></script>
<script type="text/javascript" src="js/material.min.js"></script>

<script type="text/javascript" src="js/urls.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript"
	src="http://www.parsecdn.com/js/parse-latest.js"></script>

<script>
	$.material.init();
</script>
</head>
<body>
<nav class="navbar_global navbar navbar-default navbar-static-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      
      <a class="navbar-brand" href="javascript:Utils.goPage(Urls.HOME);">Intervention <i>Online</i></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
   
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Signed in as <span class="username">[UserName]</span> <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#" >Settings</a></li>
			<li><a href="javascript:Utils.logout()" >Logout</a></li>
          </ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<div class="container">
<div class="row">

      <div class="col-md-12">
        <div class="bs-component">
          <div class="jumbotron">
          <h1>Welcome to Beta!</h1>
			<p>This is an open source project focused on automating the board game, <a href="https://www.playintervention.com/">Intervention</a>.</p>
			<p>
			<button type="button" class="login btn btn-raised btn-primary" onclick="javascript:Utils.goPage(Urls.GITHUB)">Github</button>
			</p>
          </div>
        </div>
    </div>
	
</div>

<p>
<center><h1>Let's Play Intervention <i>Online</i> </h1></center>
</p>


<div class="row">
		<div class="col-md-12">
		<div class="error alert alert-dismissible alert-danger" style="display:none" role="alert"></div>
		</div>
</div>
<div class="row">
	<div class="text-center col-md-4">
		<button type="button" class="create btn btn-lg btn-primary btn-block btn-raised" >Create Game</button>
		<div class="loading" style="display:none"> ...Generating Game... </div>
		
			<div class="game_created" style="display:none">
					<p><h4>Share this code to have players join your game</h4></p>
					<span class="generated_code"></span>
					<br/>
					<button type="button" class="login btn btn-raised btn-primary" onclick="javascript:goToManagePage()">Manage Your Game <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
			</div>
		
	</div>
	
	<div class="text-center col-md-4">
		<h2>Or</h2>
	</div>
	<div class="text-center col-md-4" style="margin-top:7px">
			 <input type="number"  class="form-control"  id="inputCode" placeholder="Enter game code, ex. 123456789">
			<div class="searching" style="display:none"> ...Searching Game... </div>
			<div class="join_game" style="display:none">
					<p><h4><span class="game_search_status"></span></h4></p>
					<br/>
					<button type="button" class="joingamebtn btn btn-raised btn-primary" disabled onclick="javascript:joinGameWithCode()">EnterGame<span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
			</div>
	</div><!-- /input-group -->
	</div>
	
</div>
</div>

</body>
<script>
$(document).ready(function() {
	if(!Utils.userLoggedIn()){
		Utils.goPage(Urls.LOGIN);
	}
	
	//setting username
	var user = Parse.User.current();
	$(".username").html(user.get("displayName"));
	
});

var manageURL;



$(".create").click(function(event) {
		create();
	});
	
	function create(){
	$('.create').prop('disabled', true);
		$(".loading").slideDown("slow",function(){getId()});
	}
	
	var timer;
	$("#inputCode").keyup(function(){
	if(!$(".searching").is(":visible")){
			$(".searching").slideDown("slow");
		}
		
		if($(".join_game").is(":visible")){
			$(".join_game").slideUp("slow");
		}
		
		clearTimeout(timer);
		
		//start or restart timer so we don't call each time they enter in code
		timer = setTimeout(searchForGame, 1000);
	});
	
	var joinGameURL = "";
	function joinGameWithCode(){
		Utils.goPage(joinGameURL);
	}
	
	function setSearchStatus(obj){
		$(".searching").slideUp("slow");
		var joinGameBtn = $(".joingamebtn");
		var joinGameWrapper = $(".join_game");
		var gameSearchStatus = $(".game_search_status");
		
		if(!joinGameWrapper.is(":visible")){
			joinGameWrapper.slideDown("slow");
		}
	
		if(obj !== -1){
			var uniqueId = obj.get("unique_id");
			var isStarted = obj.get("started");
			var ownerName = obj.get("owner_name");
			
			if(!isStarted){
			joinGameUrl = "play.html?gameId=" +String(uniqueId);
				joinGameBtn.prop("disabled",false);
				gameSearchStatus.html(ownerName + " created this game and it is active, join now!");
			} else {
				joinGameBtn.prop("disabled",true);
				gameSearchStatus.html("Cannot join game that has started");
			}
			
		}else{
			joinGameBtn.prop("disabled",true);
			gameSearchStatus.html("Oops... game not found");
		}
	}
	
	function searchForGame(){
		var GameScore = Parse.Object.extend("game");
		var query = new Parse.Query(GameScore);
		query.equalTo("unique_id", $("#inputCode").val());
		query.equalTo("active",true);
		query.find({
		  success: function(results) {
		  if(results.length>0){
			setSearchStatus(results[0]);
			} else {
			setSearchStatus(-1);
			}
		  },
		  error: function(error) {
			Utils.showError(error.message);
		  }
		});
	}
	
	//need to find a unique game id
	function getId(){
		
		var nRandomID = Utils.getRandomInt(Utils.GAME_ID_MIN, Utils.GAME_ID_MAX);
		
		var GameScore = Parse.Object.extend("game");
		var query = new Parse.Query(GameScore);
		query.equalTo("unique_id", String(nRandomID));
		query.find({
		  success: function(results) {
		  if(results.length>0){
			 return getId(); 
			} else {
			idFound(nRandomID);
			}
		  },
		  error: function(error) {
			idFound(nRandomID);
		  }
		});
	}
	
	//1234356789
	//to 123 456 780
	function formatId(id){
		var returnId="";
		//cast to string
		id = String(id)
		//split into char array
		id = id.split("");
		//iterate over each three and add a space in between
		for(var i = 0; i<id.length; i++){
			returnId+=id[i];
			
			//123
			if((i+1)%3==0)
				returnId+=" ";
		}
		
		return returnId;
	}
	
	function makeActiveGame(id){
	var Game = Parse.Object.extend("game");
	var newGame = new Game();

	newGame.set("owner_id", Utils.getCurrentUser().id);
	newGame.set("unique_id", String(id));
	newGame.set("owner_name",Utils.getCurrentUser().get("displayName"));
	newGame.set("active", true);
	newGame.set("started",false);

	newGame.save(null, {
	  success: function(newGame) {
		// Execute any logic that should take place after the object is saved.
		console.log("game created");
	  },
	  error: function(newGame, error) {
		// Execute any logic that should take place if the save fails.
		// error is a Parse.Error with an error code and message.
		Utils.showError('Failed to create game, with error code: ' + error.message);
	  }
	});
	}
	
	function idFound(id){
		$(".loading").slideUp("slow",function(){
		
		makeActiveGame(id);
		
		$(".game_created").slideDown("slow");
		
		
		$(".generated_code").html(formatId(id));
		
		var user = Parse.User.current();
		var userId = user.id;
		var link="manage.landing.html?ownerId="+userId+"&gameId="+id;
		manageURL = link;
		
		});
		
	}
	
	
	function goToManagePage(){
		alert(manageURL);
	}
	

</script>
</html>