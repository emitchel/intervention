<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>Play</title>
<meta name="description" content="Play">
<meta name="viewport" content="width=device-width">
<!-- Material Design fonts -->
<link rel="stylesheet"
	href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700"
	type="text/css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">



<!-- Bootstrap Material Design -->
<link
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	rel="stylesheet">
<link href="css/bootstrap-material-design.css" rel="stylesheet">
<link href="css/ripples.min.css" rel="stylesheet">
<link href="css/main.css" rel="stylesheet">

<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/ripples.min.js"></script>
<script type="text/javascript" src="js/material.min.js"></script>

<script type="text/javascript" src="js/urls.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript"
	src="http://www.parsecdn.com/js/parse-latest.js"></script>

<script>
	$.material.init();
</script>
</head>
<body>
<nav class="navbar_global navbar navbar-default navbar-static-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      
      <a class="navbar-brand" href="javascript:Utils.goPage(Urls.HOME);">Intervention <i>Online</i></a>
	   <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
	
	
	<ul class="nav navbar-nav navbar-right">
		<li>
				<a href="javascript:window.location.reload();">
				Refresh <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> <span class="glyphicon-class"></span>
				</a>
		</li>
	</ul>
    <!-- Collect the nav links, forms, and other content for toggling -->
	<div class="navbar-collapse collapse navbar-responsive-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Signed in as <span class="username">[UserName]</span> 
		  <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#" >Settings</a></li>
			<li><a href="javascript:Utils.logout()" >Logout</a></li>
          </ul>
        </li>
      </ul>
	  </div>
    </div><!-- /.navbar-collapse -->
</nav>
<div class="main container">
<div class="row">

      <div class="col-md-12">
        <div class="bs-component">
          <div class="jumbotron">
		  <div class="row">
				<div class="col-md-8">
			<h1>Welcome <span class="username">[UserName]</span> </h1>
			<h3>Game code</h3>
				<h3><span class="generated_code"></span></h3><br>
			</div>
			<div class="col-md-4">
			<a href="#" class="btn btn-raised btn-default" >Scoreboard</a>
			<a href="#" class=" btn btn-raised btn-default" >View Question History</a>
			</div>
			</div>
			<div class="row">
			
				<div class="col-md-12">
				<hr/>
					<span class="game_status">Waiting for  <span class="manager">[Manager]</span> to start the game</span>
					<div class="question" style="display:none"></div>
				</div>
			</div>
          </div>
        </div>
    </div>
	
</div>
<div class="row">
		<div class="col-md-12">
		<div class="error alert alert-dismissible alert-danger" style="display:none" role="alert"></div>
		
		</div>
</div>



	
</div>

</body>
<script>
var gameId;
var ownerId;
//parse objects
var game;
var owner;

//interval timer objects
var check;

var listOfAllPlayers = [];
var listOfQuestions = [];
var listOfGuesses = [];

$(document).ready(function() {
	if(!Utils.userLoggedIn()){
		Utils.goPage(Urls.LOGIN);
	}
	
	//setting username
	var user = Parse.User.current();
	$(".username").html(user.get("displayName"));
	
	gameId = Utils.getParameterByName("gameId");
	
	grabObjects();
});

//gameId and ownerId must be set.
function grabObjects(){

	var currentgame = Parse.Object.extend("game");
	var query = new Parse.Query(currentgame);
	query.equalTo("unique_id", gameId);
	query.equalTo("active",true);
	query.first({
	  success: function(object) {
		game = object;
		
		if(game==undefined){
			gameNonExistent();
		}else if(game.get("owner_id")==Utils.getCurrentUser(false).id){
			Utils.showError("You are the manager of this game! Go to the <a href='manage.html?gameId="+gameId+"'>Manager Page</a>");
			
		} else if (Utils.getCurrentUser(false).get("game_id")!== game.get("unique_id") && game.get("started")){
			Utils.showError("This game has started, you cannot join nowclick <a href='"+Urls.HOME+"'>here</a> to go home");
		} else {
			initGame();
		}
		
		
	  },
	  error: function(error) {
		Utils.showError(error.message);
	  }
	});
}

function gameNonExistent(){
	user = Utils.unsetProperty("game_id");
	$(".main").html("Game no longer exists, click <a href='"+Urls.HOME+"'>here</a> to go home");
}

function initGame(){
	//if they weren't already a part of this game, and it's started.... they can't join!
	
	
		$(".generated_code").html(Utils.formatCode(game.get("unique_id")));
		
		Utils.setUserProperty("game_id",gameId);
		console.log("setting game_id for this user");
		makeGameLock();
		
		update();
	
	
}

function makeGameLock(){
console.log("making game lock")
var GameLock = Parse.Object.extend("gameLocks");
var query = new Parse.Query(GameLock);
query.equalTo("user",Utils.getCurrentUser(true));

query.first({
  success: function(foundlock) {
    if(foundlock==undefined || foundlock.length==0){
		//need to make it 
		//(only if they've never been in a game)
		var GameLock = Parse.Object.extend("gameLocks");
		var lock = new GameLock();
		var relation = lock.relation("game");
		//lock.set("game",game);
		relation.add(game);
		
		relation = lock.relation("user");
		relation.add(Utils.getCurrentUser(false));
		//lock.set("user",Utils.getCurrentUser(false));
		
		lock.set("locked",false);
		lock.save(null, {
		  success: function(newGame) {
			// Execute any logic that should take place after the object is saved.
			console.log("lock created");
		  },
		  error: function(newGame, error) {
			// Execute any logic that should take place if the save fails.
			// error is a Parse.Error with an error code and message.
			console.log(error.message)
		  }
		});
	} else {
		//need to update it
		//game
		//blocked
		
		
		var relation = foundlock.relation("game");
		relation.add(game);
		
		relation = foundlock.relation("user");
		relation.add(Utils.getCurrentUser(false));
		
		foundlock.set("locked",false);
		foundlock.save(null, {
			  success: function(newGame) {
				// Execute any logic that should take place after the object is saved.
				console.log("lock updated");
			  },
			  error: function(newGame, error) {
				// Execute any logic that should take place if the save fails.
				// error is a Parse.Error with an error code and message.
				console.log(error.message)
			  }
			});
	}
    
  },
  error: function(lock, error) {
	Utils.showError(error.message);
  }
});
}

function update(){

	var currentgame = Parse.Object.extend("game");
	var query = new Parse.Query(currentgame);
	query.equalTo("unique_id", gameId);
	query.equalTo("active",true);
	query.first({
	  success: function(object) {
		game = object;
		
		if(game==undefined){
			gameNonExistent();
			return;
		} else if(game.get("started")){
		//get question
		//enable buttons
		
		//get everything ONCE
		getUsersInGame();
		getQuestions();
		getGuesses();
		
		} else {
		//show "waiting on manager"
		$(".manager").html(game.get("owner_name"))
		check = setTimeout(update, 1000);
		}
		
		
	  },
	  error: function(error) {
		Utils.showError(error.message);
	  }
	});
}



function getUsersInGame(){
	var Users = Parse.Object.extend("User");
		var query = new Parse.Query(Users);
		query.equalTo("game_id", String(gameId));
		query
				.find({
					success : function(results) {
						//resetting
						listOfAllPlayers = [];
						
						for ( var i = 0; i < results.length; i++) {
							listOfAllPlayers.push(results[i]);
						}
						
						 

						

					}, 
					error : function(error) {
						Utils.showError(error.message);
					}
				});
		
		//starting the timer again
}

function showQuestion(){
	//game must be started and a question selected
	//if current size of questions == questions in drop down - don't populate
}

function getQuestions(){
	if(listOfQuestions.length==0){
		var questions = Parse.Object.extend("questions");
		var query = new Parse.Query(questions);
		query
				.find({
					success : function(results) {
						//resetting
						listOfQuestions = [];
						
						for ( var i = 0; i < results.length; i++) {
							listOfQuestions.push(results[i]);
						}

						showQuestion();

					},
					error : function(error) {
						Utils.showError(error.message);
					}
				});
		} else {
			showQuestion();
		}

}

function showGuesses(){
	//if current size of guesses == size of guesses in drop down, don't populate
}

function getGuesses(){

	
	if(listOfGuesses.length==0){
	var guesses = Parse.Object.extend("Guess");
		var query = new Parse.Query(guesses);
		query
				.find({
					success : function(results) {
						//resetting
						listOfGuesses = [];
						
						for ( var i = 0; i < results.length; i++) {
							listOfGuesses.push(results[i]);
						}
				
						showGuesses();

					},
					error : function(error) {
						Utils.showError(error.message);
					}
				});
	} else {
		showGuesses();
	}
}



function setState(){
	//this is where the current state should be set. 
	//current question is all
}

function showScoreBoard(){
	//query gameScores for scores with this game
}

function showHistory(){
	//query gameResults with this game
	//game must equal the col_game order by question
	//"who is the laziest?"
	//elliot received 4 votes
	//sam received 3 votes
}

	

</script>
</html>